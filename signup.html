<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ํ์๊ฐ์</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="firebase.js"></script>
</head>

<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">ํ</a>
      <a href="ranking.html">๋ญํน</a>
      <a href="board.html">๊ฒ์ํ</a>

      <!-- ๋ก๊ทธ์ธ ์ -->
      <a href="login.html" id="loginMenu">๋ก๊ทธ์ธ</a>

      <!-- ๋ก๊ทธ์ธ ํ -->
      <span id="userMenu" style="display:none;">
        <span id="userName" style="margin-left:15px; margin-right:1px;"></span>
        <a href="#" id="logoutBtn">๋ก๊ทธ์์</a>
      </span>
    </nav>
  </div>
</header>

<div class="page-container" style="max-width:500px;">
  <h1 class="page-title">ํ์๊ฐ์</h1>

  <input class="input" id="email" placeholder="์ด๋ฉ์ผ">
  <input class="input" id="nickname" placeholder="๋๋ค์">
  <input class="input" id="password" type="password" placeholder="๋น๋ฐ๋ฒํธ">

  <button class="btn-primary" id="signupBtn">ํ์๊ฐ์</button>

  <hr style="border-color:#333; margin:25px 0;">

  <button class="btn-outline" id="googleSignup">Google๋ก ๊ฐ์ํ๊ธฐ</button>
</div>

<script>
  const auth = firebase.auth();
  let isSigningUp = false; // โญ ํต์ฌ ํ๋๊ทธ

  /* ===============================
     0๏ธโฃ ๋ก๊ทธ์ธ๋ ์ฌ์ฉ์ URL ์ง์ ์๊ทผ ์ฐจ๋จ
  =============================== */
  auth.onAuthStateChanged(user => {
    const loginMenu = document.getElementById("loginMenu");
    const userMenu = document.getElementById("userMenu");
    const userName = document.getElementById("userName");

    if (user) {
      loginMenu.style.display = "none";
      userMenu.style.display = "inline";
      const name = user.displayName || user.email;
      userName.textContent = `[${name}]`;

      // ๐ฅ ํ์๊ฐ์ ์ค์ด ์๋ ๋๋ง ์ฐจ๋จ
      if (!isSigningUp) {
        alert("์ด๋ฏธ ๋ก๊ทธ์ธ๋ ์ํ์์๋ ํ์๊ฐ์ํ ์ ์์ต๋๋ค.");
        location.replace("index.html");
      }
    } else {
      loginMenu.style.display = "inline";
      userMenu.style.display = "none";
    }
  });

  /* ===============================
     1๏ธโฃ ์ด๋ฉ์ผ ํ์๊ฐ์
  =============================== */
  document.getElementById("signupBtn").onclick = async () => {
    isSigningUp = true; // โญ ์ค์

    const email = document.getElementById("email").value.trim();
    const nickname = document.getElementById("nickname").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!email || !nickname || !password) {
      isSigningUp = false;
      alert("๋ชจ๋ ํญ๋ชฉ์ ์๋ฅํด์ฃผ์ธ์.");
      return;
    }

    try {
      const result = await auth.createUserWithEmailAndPassword(email, password);

      await result.user.updateProfile({
        displayName: nickname
      });

      await result.user.sendEmailVerification();

      alert(
        "ํ์๊ฐ์ ์๋ฃ!\n\n" +
        "์ด๋ฉ์ผ๋ก ์ธ์ฆ ๋งํฌ๊ฐ ์์ก๋์์ต๋๋ค.\n" +
        "์ธ์ฆ ํ ๋ก๊ทธ์ธํด์ฃผ์ธ์."
      );

      // ์ธ์ฆ ์ ๋ก๊ทธ์ธ ๋ฐฉ์ง
      await auth.signOut();
      location.href = "login.html";

    } catch (error) {
      isSigningUp = false;
      console.error(error);
      alert("ํ์๊ฐ์ ์ค๋ฅ: " + error.message);
    }
  };

  /* ===============================
     2๏ธโฃ Google ํ์๊ฐ์
  =============================== */
  document.getElementById("googleSignup").onclick = async () => {
    isSigningUp = true;

    const provider = new firebase.auth.GoogleAuthProvider();

    try {
      await auth.signInWithPopup(provider);
      alert("Google ํ์๊ฐ์ ์๋ฃ!");
      location.href = "index.html";
    } catch (e) {
      isSigningUp = false;
      alert("์ค๋ฅ: " + e.message);
    }
  };

  /* ===============================
     3๏ธโฃ ๋ก๊ทธ์์
  =============================== */
  document.addEventListener("click", e => {
    if (e.target.id === "logoutBtn") {
      e.preventDefault();
      auth.signOut().then(() => {
        alert("๋ก๊ทธ์์ ๋์์ต๋๋ค.");
        location.reload();
      });
    }
  });
</script>

</body>
</html>
