<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê²Œì‹œê¸€ ë³´ê¸° - í˜¸ê·¸ ì£¼ë¨¹ì „</title>
<link rel="stylesheet" href="style.css">
</head>

<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">í™ˆ</a>
      <a href="ranking.html">ë­í‚¹</a>
      <a href="board.html">ê²Œì‹œíŒ</a>

      <a href="login.html" id="loginMenu">ë¡œê·¸ì¸</a>

      <span id="userMenu" style="display:none;">
        <span id="userName" style="margin-right:10px;"></span>
        <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
      </span>
    </nav>
  </div>
</header>

<div class="page-container">
  <h1 class="page-title" id="postTitle">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
  <p id="postInfo"></p>

  <div id="postContent" style="margin-top:20px; white-space:pre-wrap;"></div>

  <button id="deletePostBtn" class="btn-outline"
    style="display:none; margin-top:20px;">
    ê¸€ ì‚­ì œ
  </button>

  <hr style="margin:40px 0; border-color:#333;">

<div class="comment-card">
  <h3>ëŒ“ê¸€</h3>

  <div id="commentList" class="comment-list"></div>

  <!-- í˜ì´ì§€ ë²„íŠ¼ -->
  <div id="commentPagination" style="margin-top:15px; text-align:center;"></div>

  <!-- ëŒ“ê¸€ ì‘ì„± -->
  <div id="commentForm" class="comment-input-box" style="display:none;">
    <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <button id="commentSubmit" class="comment-btn">ëŒ“ê¸€ ë“±ë¡</button>
  </div>
</div>

  <a href="board.html" class="btn-outline" style="margin-top:30px;">
    ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
  </a>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
/* ===============================
   ìœ í‹¸
================================ */
const postId = new URLSearchParams(location.search).get("id");

if (!postId) {
  alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
  location.replace("board.html");
}

const postRef = firebase.database().ref("posts/" + postId);
const commentRef = firebase.database().ref("comments/" + postId);

let currentUser = null;
let postAuthorUid = null;

/* ===============================
   ë¡œê·¸ì¸ ìƒíƒœ
================================ */
firebase.auth().onAuthStateChanged(user => {
  currentUser = user;

  const loginMenu = document.getElementById("loginMenu");
  const userMenu = document.getElementById("userMenu");
  const userName = document.getElementById("userName");
  const commentForm = document.getElementById("commentForm");

  if (user) {
    loginMenu.style.display = "none";
    userMenu.style.display = "inline";
    userName.textContent = `[${user.displayName || user.email}]`;
    commentForm.style.display = "block";
  } else {
    loginMenu.style.display = "inline";
    userMenu.style.display = "none";
    commentForm.style.display = "none";
  }

  updateDeleteButton();
});

/* ===============================
   ë¡œê·¸ì•„ì›ƒ
================================ */
document.addEventListener("click", e => {
  if (e.target.id === "logoutBtn") {
    e.preventDefault();
    firebase.auth().signOut().then(() => location.reload());
  }
});

/* ===============================
   ê²Œì‹œê¸€ ë¡œë“œ
================================ */
postRef.once("value").then(snapshot => {
  if (!snapshot.exists()) {
    alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œê¸€ì…ë‹ˆë‹¤.");
    location.replace("board.html");
    return;
  }

  const post = snapshot.val();
  postAuthorUid = post.authorUid;

  document.getElementById("postTitle").textContent = post.title;
  document.getElementById("postInfo").textContent =
    `ì‘ì„±ì: ${post.author} | ì‘ì„±ì¼: ${post.createdAt}`;
  document.getElementById("postContent").innerHTML = post.content;

  updateDeleteButton();
});


/* ===============================
   ì‚­ì œ ë²„íŠ¼ ì œì–´
================================ */
function updateDeleteButton() {
  const btn = document.getElementById("deletePostBtn");

  if (currentUser && postAuthorUid && currentUser.uid === postAuthorUid) {
    btn.style.display = "inline-block";
  } else {
    btn.style.display = "none";
  }
}

document.getElementById("deletePostBtn").onclick = async () => {
  if (!confirm("ì •ë§ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  try {
    // ğŸ”¥ ëŒ“ê¸€ ë¦¬ìŠ¤ë„ˆë§Œ ëŠê³ 
    commentRef.off();

    // ğŸ”¥ ê²Œì‹œë¬¼ë§Œ ì‚­ì œ
    await postRef.remove();

    location.replace("board.html");
  } catch (e) {
    alert("ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨");
    console.error(e);
  }
};


/* ===============================
   ëŒ“ê¸€ ì‘ì„±
================================ */
document.getElementById("commentSubmit").onclick = async () => {
  if (!currentUser) return;

  const btn = document.getElementById("commentSubmit");
  btn.disabled = true;

  const input = document.getElementById("comment-input");
  const content = input.value.trim();
  if (!content) {
    btn.disabled = false;
    return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.");
  }
  
  await commentRef.push({
    content,
    author: currentUser.displayName || currentUser.email,
    authorUid: currentUser.uid,
    createdAt: new Date().toLocaleString()
  });

  input.value = "";

  // ğŸ”¥ ìƒˆ ëŒ“ê¸€ ì‘ì„± í›„ ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™
  currentPage = Math.ceil((allComments.length + 1) / COMMENTS_PER_PAGE);

  btn.disabled = false;
};


async function deleteComment(commentId) {
  if (!confirm("ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  try {
    await commentRef.child(commentId).remove();
  } catch (e) {
    alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨");
    console.error(e);
  }
}


const COMMENTS_PER_PAGE = 5;
let currentPage = 1;
let allComments = [];

// ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤ì‹œê°„)
commentRef.on("value", snapshot => {
  allComments = [];

  if (snapshot.exists()) {
    snapshot.forEach(child => {
      allComments.push({
        id: child.key,
        ...child.val()
      });
    });
  }

  renderComments();
  renderPagination();
});

// ëŒ“ê¸€ ë Œë”ë§
function renderComments() {
  const list = document.getElementById("commentList");
  list.innerHTML = "";

  const start = (currentPage - 1) * COMMENTS_PER_PAGE;
  const end = start + COMMENTS_PER_PAGE;
  const pageComments = allComments.slice(start, end);

  pageComments.forEach(c => {
    const div = document.createElement("div");
    div.className = "comment";

    let deleteBtn = "";
    if (currentUser && c.authorUid === currentUser.uid) {
      deleteBtn = `
        <button class="comment-btn"
                style="margin-top:5px; width:auto; padding:5px 10px;"
                onclick="deleteComment('${c.id}')">
          ì‚­ì œ
        </button>
      `;
    }

    div.innerHTML = `
      <strong>${c.author}</strong>
      <p>${c.content}</p>
      <small>${c.createdAt}</small>
      ${deleteBtn}
    `;

    list.appendChild(div);
  });
}

// í˜ì´ì§€ ë²„íŠ¼ ë Œë”ë§
function renderPagination() {
  const pagination = document.getElementById("commentPagination");
  pagination.innerHTML = "";

  const totalPages = Math.ceil(allComments.length / COMMENTS_PER_PAGE);
  if (totalPages <= 1) return;

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = "btn-outline";
    btn.style.margin = "0 5px";

    if (i === currentPage) {
      btn.style.opacity = "0.6";
    }

    btn.onclick = () => {
      currentPage = i;
      renderComments();
    };

    pagination.appendChild(btn);
  }
}

  
</script>

</body>
</html>










