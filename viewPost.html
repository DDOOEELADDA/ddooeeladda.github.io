<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>게시글 보기 - 호그 주먹전</title>
<link rel="stylesheet" href="style.css">
</head>

<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">홈</a>
      <a href="ranking.html">랭킹</a>
      <a href="board.html">게시판</a>

      <a href="login.html" id="loginMenu">로그인</a>

      <span id="userMenu" style="display:none;">
        <span id="userName" style="margin-right:10px;"></span>
        <a href="#" id="logoutBtn">로그아웃</a>
      </span>
    </nav>
  </div>
</header>

<div class="page-container">
  <h1 class="page-title" id="postTitle">불러오는 중...</h1>
  <p id="postInfo"></p>

  <div id="postContent" style="margin-top:20px; white-space:pre-wrap;"></div>

  <button id="deletePostBtn" class="btn-outline"
    style="display:none; margin-top:20px;">
    글 삭제
  </button>

  <hr style="margin:40px 0; border-color:#333;">

  <h3>댓글</h3>
  <div id="commentList"></div>

  <!-- 댓글 작성 -->
  <div id="commentForm" style="display:none; margin-top:20px;">
    <textarea
      id="commentInput"
      class="textarea"
      placeholder="댓글을 입력하세요"
      style="width:100%; max-width:400px; height:100px;"
    ></textarea>
    <button id="commentSubmit" class="btn-primary">댓글 등록</button>
  </div>

  <a href="board.html" class="btn-outline" style="margin-top:30px;">
    목록으로 돌아가기
  </a>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
/* ===============================
   유틸
================================ */
const postId = new URLSearchParams(location.search).get("id");

if (!postId) {
  alert("잘못된 접근입니다.");
  location.replace("board.html");
}

const postRef = firebase.database().ref("posts/" + postId);
const commentRef = firebase.database().ref("comments/" + postId);

let currentUser = null;
let postAuthorUid = null;

/* ===============================
   로그인 상태
================================ */
firebase.auth().onAuthStateChanged(user => {
  currentUser = user;

  const loginMenu = document.getElementById("loginMenu");
  const userMenu = document.getElementById("userMenu");
  const userName = document.getElementById("userName");
  const commentForm = document.getElementById("commentForm");

  if (user) {
    loginMenu.style.display = "none";
    userMenu.style.display = "inline";
    userName.textContent = `[${user.displayName || user.email}]`;
    commentForm.style.display = "block";
  } else {
    loginMenu.style.display = "inline";
    userMenu.style.display = "none";
    commentForm.style.display = "none";
  }

  updateDeleteButton();
});

/* ===============================
   로그아웃
================================ */
document.addEventListener("click", e => {
  if (e.target.id === "logoutBtn") {
    e.preventDefault();
    firebase.auth().signOut().then(() => location.reload());
  }
});

/* ===============================
   게시글 로드
================================ */
postRef.once("value").then(snapshot => {
  if (!snapshot.exists()) {
    alert("존재하지 않는 게시글입니다.");
    location.replace("board.html");
    return;
  }

  const post = snapshot.val();
  postAuthorUid = post.authorUid;

  document.getElementById("postTitle").textContent = post.title;
  document.getElementById("postInfo").textContent =
    `작성자: ${post.author} | 작성일: ${post.createdAt}`;
  document.getElementById("postContent").innerHTML = post.content;

  updateDeleteButton();
});
  
commentRef.on("value", snapshot => {
  const list = document.getElementById("commentList");
  list.innerHTML = "";

  snapshot.forEach(child => {
    const c = child.val();
    const commentId = child.key;

    const div = document.createElement("div");
    div.style.marginBottom = "15px";

    let deleteBtn = "";
    if (currentUser && c.authorUid === currentUser.uid) {
      deleteBtn = `
        <button class="btn-outline"
                style="font-size:12px; margin-top:5px;"
                onclick="deleteComment('${commentId}')">
          삭제
        </button>
      `;
    }

    div.innerHTML = `
      <strong>${c.author}</strong>
      <p>${c.content}</p>
      <small>${c.createdAt}</small>
      ${deleteBtn}
      <hr style="border-color:#333;">
    `;

    list.appendChild(div);
  });
});


/* ===============================
   삭제 버튼 제어
================================ */
function updateDeleteButton() {
  const btn = document.getElementById("deletePostBtn");

  if (currentUser && postAuthorUid && currentUser.uid === postAuthorUid) {
    btn.style.display = "inline-block";
  } else {
    btn.style.display = "none";
  }
}

document.getElementById("deletePostBtn").onclick = async () => {
  if (!confirm("정말 이 글을 삭제하시겠습니까?")) return;

  try {
    await postRef.remove();
    await commentRef.remove();
    location.replace("board.html");
  } catch (e) {
    alert("게시글 삭제 실패");
    console.error(e);
  }
};


/* ===============================
   댓글 작성
================================ */
document.getElementById("commentSubmit").onclick = async () => {
  if (!currentUser) return;

  const btn = document.getElementById("commentSubmit");
  btn.disabled = true;

  const input = document.getElementById("commentInput");
  const content = input.value.trim();
  if (!content) {
    btn.disabled = false;
    return alert("댓글을 입력하세요.");
  }

  await commentRef.push({
    content,
    author: currentUser.displayName || currentUser.email,
    authorUid: currentUser.uid,
    createdAt: new Date().toLocaleString()
  });

  input.value = "";
  btn.disabled = false;
};

async function deleteComment(commentId) {
  if (!confirm("이 댓글을 삭제하시겠습니까?")) return;

  try {
    await commentRef.child(commentId).remove();
  } catch (e) {
    alert("댓글 삭제 실패");
    console.error(e);
  }
}

</script>

</body>
</html>



