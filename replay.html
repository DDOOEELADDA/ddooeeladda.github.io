<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¦¬í”Œë ˆì´ ì œì¶œ - í˜¸ê·¸ ì£¼ë¨¹ì „</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">í™ˆ</a>
      <a href="ranking.html">ë­í‚¹</a>
      <a href="board.html">ê²Œì‹œíŒ</a>
    </nav>
  </div>
</header>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
<script src="firebase.js"></script>

<div class="page-container">
  <h1 class="page-title">ë¦¬í”Œë ˆì´ ì½”ë“œ ì œì¶œ</h1>

  <p>
    ê²½ê¸° í›„, ë°œê¸‰í•œ <strong>í˜¸ê·¸ ì£¼ë¨¹ì „ 1ëŒ€1 ë¦¬í”Œë ˆì´ ì½”ë“œ</strong>ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
  </p>

  <input
    id="replayInput"
    placeholder="ì˜ˆ: DX3J3Q"
    style="padding:10px; width:250px;"
  />

  <br><br>

  <button id="submitReplayBtn" class="btn-outline">
    ì œì¶œí•˜ê¸°
  </button>

  <div id="resultMsg" style="margin-top:20px;"></div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {

  var resultMsg = document.getElementById("resultMsg");

  document.getElementById("submitReplayBtn").addEventListener("click", function () {

    var replayCode = document.getElementById("replayInput").value.trim();
    replayCode = replayCode.toUpperCase();
    
    if (!replayCode) {
      resultMsg.innerText = "ë¦¬í”Œë ˆì´ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
      return;
    }
    
    var codePattern = /^[A-Z0-9]{6}$/;
    
    if (!codePattern.test(replayCode)) {
      resultMsg.innerText = "ìœ íš¨í•œ ë¦¬í”Œë ˆì´ ì½”ë“œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.";
      return;
    }
    
    var deviceId = localStorage.getItem("deviceId");
    if (!deviceId) {
      deviceId = "device_" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("deviceId", deviceId);
    }

    var now = Date.now();
    var limitRef = database.ref("deviceLimits/" + deviceId);

    limitRef.once("value").then(function(snapshot) {
      var data = snapshot.val();

      if (data && data.lastSubmit) {

        var diff = now - data.lastSubmit;
        var limit = 3 * 60 * 60 * 1000; // 3ì‹œê°„

        if (diff < limit) {

          var remaining = limit - diff;

          var hours = Math.floor(remaining / (1000 * 60 * 60));
          var minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
          var seconds = Math.floor((remaining % (1000 * 60)) / 1000);

          resultMsg.innerText =
            "ì¬ì œì¶œê¹Œì§€ ë‚¨ì€ ì‹œê°„: " +
            hours + "ì‹œê°„ " +
            minutes + "ë¶„ " +
            seconds + "ì´ˆ";

          return;
        }
      }

      // ì œì¶œ ê°€ëŠ¥
    // ğŸ”¥ ì¤‘ë³µ ì½”ë“œ ê²€ì‚¬
    database.ref("replays")
      .orderByChild("code")
      .equalTo(replayCode)
      .once("value")
      .then(function(snapshot) {
    
        if (snapshot.exists()) {
          resultMsg.innerText = "ì´ë¯¸ ì œì¶œëœ ë¦¬í”Œë ˆì´ ì½”ë“œì…ë‹ˆë‹¤.";
          return;
        }
    
        // ì¤‘ë³µ ì•„ë‹ˆë©´ ì €ì¥
        database.ref("replays").push({
          code: replayCode,
          deviceId: deviceId,
          submittedAt: now
        });
    
        limitRef.set({
          lastSubmit: now
        });
    
        resultMsg.innerText = "ì œì¶œ ì™„ë£Œ!";
        document.getElementById("replayInput").value = "";
    
      });

      limitRef.set({
        lastSubmit: now
      });

      resultMsg.innerText = "ì œì¶œ ì™„ë£Œ!";
      document.getElementById("replayInput").value = "";
    });

  });

});
</script>
</body>
</html>
