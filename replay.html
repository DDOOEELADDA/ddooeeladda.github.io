<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>리플레이 제출 - 호그 주먹전</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">홈</a>
      <a href="ranking.html">랭킹</a>
      <a href="board.html">게시판</a>
    </nav>
  </div>
</header>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
<script src="firebase.js"></script>

<div class="page-container">
  <h1 class="page-title">리플레이 코드 제출</h1>

  <p>
    경기 후, 발급한 <strong>호그 주먹전 1대1 리플레이 코드</strong>를 입력하세요.
  </p>

  <input
    id="replayInput"
    placeholder="예: DX3J3Q"
    style="padding:10px; width:250px;"
  />

  <br><br>

  <button id="submitReplayBtn" class="btn-outline">
    제출하기
  </button>

  <div id="resultMsg" style="margin-top:20px;"></div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {

  var resultMsg = document.getElementById("resultMsg");

  document.getElementById("submitReplayBtn").addEventListener("click", function () {

    var replayCode = document.getElementById("replayInput").value.trim();

    if (!replayCode) {
      resultMsg.innerText = "리플레이 코드를 입력하세요.";
      return;
    }

    var deviceId = localStorage.getItem("deviceId");
    if (!deviceId) {
      deviceId = "device_" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("deviceId", deviceId);
    }

    var now = Date.now();
    var limitRef = database.ref("deviceLimits/" + deviceId);

    limitRef.once("value").then(function(snapshot) {
      var data = snapshot.val();

      if (data && data.lastSubmit) {

        var diff = now - data.lastSubmit;
        var limit = 3 * 60 * 60 * 1000; // 3시간

        if (diff < limit) {

          var remaining = limit - diff;

          var hours = Math.floor(remaining / (1000 * 60 * 60));
          var minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
          var seconds = Math.floor((remaining % (1000 * 60)) / 1000);

          resultMsg.innerText =
            "재제출까지 남은 시간: " +
            hours + "시간 " +
            minutes + "분 " +
            seconds + "초";

          return;
        }
      }

      // 제출 가능
      database.ref("replays").push({
        code: replayCode,
        deviceId: deviceId,
        submittedAt: now
      });

      limitRef.set({
        lastSubmit: now
      });

      resultMsg.innerText = "제출 완료!";
      document.getElementById("replayInput").value = "";
    });

  });

});
</script>
</body>
</html>
