<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê²Œì‹œíŒ - í˜¸ê·¸ ì£¼ë¨¹ì „</title>
  <link rel="stylesheet" href="style.css">
</head>

<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">í™ˆ</a>
      <a href="ranking.html">ë­í‚¹</a>
      <a href="board.html">ê²Œì‹œíŒ</a>

      <!-- ë¡œê·¸ì¸ ì „ -->
      <a href="login.html" id="loginMenu">ë¡œê·¸ì¸</a>

      <!-- ë¡œê·¸ì¸ í›„ -->
      <span id="userMenu" style="display:none;">
        <span id="userName" style="margin-left:15px; margin-right:1px;"></span>
        <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
      </span>
    </nav>
  </div>
</header>

<div class="board-container">
  <div class="board-header">
    <h2>ì „ì²´ ê¸€ ëª©ë¡</h2>
    <button class="write-btn" id="writeBtn">ê¸€ì“°ê¸°</button>
  </div>

  <table class="board-table">
    <thead>
      <tr>
        <th style="width:60px;">ë²ˆí˜¸</th>
        <th>ì œëª©</th>
        <th style="width:150px;">ì‘ì„±ì</th>
        <th style="width:150px;">ì‘ì„±ì¼</th>
        <th style="width:80px;">ì¡°íšŒ</th>
        <th style="width:90px;">ê´€ë¦¬</th>
      </tr>
    </thead>
    <tbody id="postList"></tbody>
  </table>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
let currentUser = null;

/* ===============================
   ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€
================================ */
firebase.auth().onAuthStateChanged(user => {
  currentUser = user;

  const loginMenu = document.getElementById("loginMenu");
  const userMenu = document.getElementById("userMenu");
  const userName = document.getElementById("userName");

  if (user) {
    loginMenu.style.display = "none";
    userMenu.style.display = "inline";
    userName.textContent = `[${user.displayName || user.email}]`;
  } else {
    loginMenu.style.display = "inline";
    userMenu.style.display = "none";
  }

  loadPosts();
});

/* ===============================
   ë¡œê·¸ì•„ì›ƒ
================================ */
document.addEventListener("click", e => {
  if (e.target.id === "logoutBtn") {
    e.preventDefault();
    firebase.auth().signOut().then(() => {
      location.reload();
    });
  }
});

/* ===============================
   ê¸€ì“°ê¸° (ë¡œê·¸ì¸ ìƒê´€ ì—†ìŒ)
================================ */
document.getElementById("writeBtn").onclick = () => {
  location.href = "writePost.html";
};

/* ===============================
   ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
================================ */
async function loadPosts() {
  const tbody = document.getElementById("postList");
  tbody.innerHTML = "";

  const snapshot = await firebase.database().ref("posts").get();
  if (!snapshot.exists()) return;

  const posts = [];
  snapshot.forEach(child => {
    posts.push({ key: child.key, ...child.val() });
  });

  posts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

  posts.forEach((post, index) => {
    const tr = document.createElement("tr");

    // ğŸ”¥ ì‚­ì œ ë²„íŠ¼ ì¡°ê±´
    let deleteBtn = "";
    if (
      currentUser &&
      post.authorUid &&
      post.authorUid === currentUser.uid
    ) {
      deleteBtn = `<button class="btn-outline btn-small" data-key="${post.key}">ì‚­ì œ</button>`;
    }

    tr.innerHTML = `
      <td>${index + 1}</td>
      <td><a href="#" class="post-link">${post.title}</a></td>
      <td>${post.author}</td>
      <td>${post.createdAt}</td>
      <td>${post.views || 0}</td>
      <td>${deleteBtn}</td>
    `;

    // ì¡°íšŒìˆ˜ ì¦ê°€ + ê¸€ ë³´ê¸°
    tr.querySelector(".post-link").onclick = async e => {
      e.preventDefault();

      const viewRef = firebase.database().ref("posts/" + post.key + "/views");
      const snap = await viewRef.get();
      await viewRef.set((snap.val() || 0) + 1);

      location.href = `viewPost.html?id=${post.key}`;
    };

    // ğŸ”¥ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
    const btn = tr.querySelector("button");
    if (btn) {
      btn.onclick = async () => {
        if (!confirm("ì •ë§ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        await firebase.database().ref("posts/" + post.key).remove();
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadPosts();
      };
    }

    tbody.appendChild(tr);
  });
}
</script>

</body>
</html>

