<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>게시판 - 호그 주먹전</title>
<link rel="stylesheet" href="style.css">
</head>
<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">홈</a>
      <a href="ranking.html">랭킹</a>
      <a href="board.html">게시판</a>
      <a href="login.html">로그인</a>
    </nav>
  </div>
</header>

<div class="board-container">
  <div class="board-header">
    <h2>전체 글 목록</h2>
    <button class="write-btn" onclick="location.href='writePost.html'">글쓰기</button>
  </div>

  <table class="board-table">
    <thead>
      <tr>
        <th style="width:60px;">번호</th>
        <th>제목</th>
        <th style="width:150px;">작성자</th>
        <th style="width:150px;">작성일</th>
        <th style="width:80px;">조회</th>
      </tr>
    </thead>
    <tbody id="postList"></tbody>
  </table>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
async function loadPosts() {
  const snapshot = await firebase.database().ref("posts").get();
  const posts = [];

  snapshot.forEach((child) => {
    posts.push({ key: child.key, ...child.val() });
  });

  // 최신 글 위로 정렬
  posts.sort((a,b)=>a.createdAt < b.createdAt ? 1:-1);

  const tbody = document.getElementById("postList");
  tbody.innerHTML = "";

  posts.forEach((post,index)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${index+1}</td>
      <td><a href="#">${post.title}</a></td>
      <td>${post.author}</td>
      <td>${post.createdAt}</td>
      <td id="views-${post.key}">${post.views || 0}</td>
    `;
    tbody.appendChild(tr);

    // 글 클릭 시 조회수 1 증가 + viewPost.html 이동
    tr.querySelector("a").addEventListener("click", async (e)=>{
      e.preventDefault();
      const postRef = firebase.database().ref("posts/" + post.key + "/views");
      const snap = await postRef.get();
      const currentViews = snap.exists() ? snap.val() : 0;
      await postRef.set(currentViews + 1);

      // 실시간 조회수 업데이트
      document.getElementById(`views-${post.key}`).textContent = currentViews + 1;

      // viewPost.html로 이동 (query string 전달)
      const url = `viewPost.html?title=${encodeURIComponent(post.title)}&author=${encodeURIComponent(post.author)}&createdAt=${encodeURIComponent(post.createdAt)}`;
      window.location.href = url;
    });
  });
}

document.addEventListener("DOMContentLoaded", loadPosts);
</script>
</body>
</html>
