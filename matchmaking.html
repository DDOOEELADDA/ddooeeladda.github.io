<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>공식 매치메이킹 - 호그 주먹전</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">홈</a>
      <a href="board.html">게시판</a>
      <span id="userMenu" style="display:none;">
        <span id="userName"></span>
        <a href="#" id="logoutBtn">로그아웃</a>
      </span>
    </nav>
  </div>
</header>

<div class="page-container">

  <!-- 배틀태그 등록 -->
  <div id="battleTagSection" style="display:none;">
    <h1 class="page-title">배틀태그 등록</h1>
    <p>공식 매치 참여를 위해 <strong>오버워치2 배틀태그</strong>를 등록해야 합니다.</p>

    <input id="battleTagInput"
           placeholder="닉네임#1234"
           style="margin-top:15px; width:250px; padding:10px;" />

    <br><br>
    <button id="saveBattleTag" class="btn-outline">등록</button>
  </div>

  <!-- 매치메이킹 -->
  <div id="matchmakingSection" style="display:none;">
    <h1 class="page-title">공식 매치메이킹</h1>

    <p id="myBattleTag"></p>

    <button id="findMatchBtn" class="btn-outline">매치 찾기</button>

    <div id="matchStatus" style="margin-top:25px;"></div>
  </div>

</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
let currentUser = null;
let myBattleTag = null;

firebase.auth().onAuthStateChanged(async user => {
  if (!user) {
    alert("로그인이 필요합니다.");
    location.replace("login.html");
    return;
  }

  currentUser = user;
  document.getElementById("userMenu").style.display = "inline";
  document.getElementById("userName").textContent = `[${user.email}]`;

  const snap = await firebase.database()
    .ref("users/" + user.uid + "/battleTag")
    .once("value");

  if (!snap.exists()) {
    document.getElementById("battleTagSection").style.display = "block";
  } else {
    myBattleTag = snap.val();
    showMatchmaking();
  }
});

// 로그아웃
document.getElementById("logoutBtn").onclick = e => {
  e.preventDefault();
  firebase.auth().signOut().then(() => location.reload());
};

// 배틀태그 저장
document.getElementById("saveBattleTag").onclick = async () => {
  const input = document.getElementById("battleTagInput");
  const tag = input.value.trim();

  if (!/^.{3,12}#[0-9]{4,6}$/.test(tag)) {
    alert("배틀태그 형식이 올바르지 않습니다.");
    return;
  }

  try {
    await firebase.database().ref("users/" + currentUser.uid).set({
      battleTag: tag,
      createdAt: new Date().toISOString()
    });

    myBattleTag = tag;
    showMatchmaking();
  } catch (e) {
    alert("배틀태그 등록 실패");
    console.error(e);
  }
};

function showMatchmaking() {
  document.getElementById("battleTagSection").style.display = "none";
  document.getElementById("matchmakingSection").style.display = "block";
  document.getElementById("myBattleTag").textContent = `내 배틀태그: ${myBattleTag}`;
}

// 매치 찾기 (서버 API 연결 예정)
document.getElementById("findMatchBtn").onclick = () => {
  document.getElementById("matchStatus").innerHTML = `
    <p>매치메이킹 대기 중...</p>
    <p style="opacity:0.7;">상대 플레이어를 찾고 있습니다.</p>
  `;
};
</script>

</body>
</html>
