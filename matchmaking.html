<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê³µì‹ ë§¤ì¹˜ë©”ì´í‚¹ - í˜¸ê·¸ ì£¼ë¨¹ì „</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">í™ˆ</a>
      <a href="ranking.html">ë­í‚¹</a>
      <a href="board.html">ê²Œì‹œíŒ</a>

      <!-- ë¡œê·¸ì¸ ì „ -->
      <a href="login.html" id="loginMenu">ë¡œê·¸ì¸</a>

      <!-- ë¡œê·¸ì¸ í›„ -->
      <span id="userMenu" style="display:none;">
        <span id="userName" style="margin-left:15px; margin-right:5px;"></span>
        <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
      </span>
    </nav>
  </div>
</header>

<div class="page-container">

  <!-- ë°°í‹€íƒœê·¸ ë“±ë¡ -->
  <div id="battleTagSection" style="display:none;">
    <h1 class="page-title">ë°°í‹€íƒœê·¸ ë“±ë¡</h1>
    <p>
      ê³µì‹ ë§¤ì¹˜ ì°¸ì—¬ë¥¼ ìœ„í•´<br>
      <strong>ì˜¤ë²„ì›Œì¹˜2 ë°°í‹€íƒœê·¸</strong>ë¥¼ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.
    </p>

    <input
      id="battleTagInput"
      placeholder="ë‹‰ë„¤ì„#1234"
      style="margin-top:15px; width:250px; padding:10px;"
    />

    <br><br>
    <button id="saveBattleTag" class="btn-outline">ë“±ë¡</button>
  </div>

  <!-- ë§¤ì¹˜ë©”ì´í‚¹ -->
  <div id="matchmakingSection" style="display:none;">
    <h1 class="page-title">ê³µì‹ ë§¤ì¹˜ë©”ì´í‚¹</h1>

    <p id="myBattleTag"></p>

    <button id="findMatchBtn" class="btn-outline">ë§¤ì¹˜ ì°¾ê¸°</button>

    <div id="matchStatus" style="margin-top:25px;"></div>
  </div>

</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
let currentUser = null;
let myBattleTag = null;
let currentMatch = null;
let currentMatchId = null;
let matchListener = null;


/* =========================
   ë¡œê·¸ì¸ ì²´í¬
========================= */
firebase.auth().onAuthStateChanged(async user => {
  if (!user) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    location.replace("login.html");
    return;
  }

  currentUser = user;

  document.getElementById("loginMenu").style.display = "none";
  document.getElementById("userMenu").style.display = "inline";
  document.getElementById("userName").textContent =
    `[${user.displayName || user.email}]`;

  const snap = await firebase.database()
    .ref("users/" + user.uid + "/battleTag")
    .once("value");

  if (!snap.exists()) {
    document.getElementById("battleTagSection").style.display = "block";
  } else {
    myBattleTag = snap.val();
    showMatchmaking();
  }
});

/* =========================
   ë¡œê·¸ì•„ì›ƒ
========================= */
document.getElementById("logoutBtn").onclick = e => {
  e.preventDefault();
  firebase.auth().signOut().then(() => location.reload());
};

/* =========================
   ë°°í‹€íƒœê·¸ ì €ì¥ (ğŸ”¥ í•µì‹¬ ìˆ˜ì •)
========================= */
document.getElementById("saveBattleTag").onclick = async () => {
  const input = document.getElementById("battleTagInput");
  const tag = input.value.trim();

  if (!/^.{3,12}#[0-9]{4,6}$/.test(tag)) {
    alert("ë°°í‹€íƒœê·¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë‹‰ë„¤ì„#1234)");
    return;
  }

  try {
    const userRef = firebase.database().ref("users/" + currentUser.uid);

    // ğŸ”¥ Rulesì— ë§ê²Œ child ë‹¨ìœ„ë¡œ ì €ì¥
    await userRef.child("battleTag").set(tag);
    await userRef.child("createdAt").set(new Date().toISOString());

    myBattleTag = tag;
    showMatchmaking();

  } catch (e) {
    alert("ë°°í‹€íƒœê·¸ ë“±ë¡ ì‹¤íŒ¨");
    console.error(e);
  }
};

/* =========================
   ë§¤ì¹˜ë©”ì´í‚¹ í™”ë©´ í‘œì‹œ
========================= */
function showMatchmaking() {
  document.getElementById("battleTagSection").style.display = "none";
  document.getElementById("matchmakingSection").style.display = "block";
  document.getElementById("myBattleTag").textContent =
    `ë‚´ ë°°í‹€íƒœê·¸: ${myBattleTag}`;

  watchMyMatch(); // ğŸ”¥ ì¶”ê°€
}

/* =========================
   ë§¤ì¹˜ ì°¾ê¸° (ì„œë²„ ì—°ë™ ì˜ˆì •)
========================= */
document.getElementById("findMatchBtn").onclick = async () => {
  document.getElementById("matchStatus").innerHTML =
    "<p>ë§¤ì¹˜ë©”ì´í‚¹ ëŒ€ê¸° ì¤‘...</p>";

  try {
    const res = await fetch(
      "https://https://hogboxing-fucntions.vercel.app/api/match-find",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          uid: currentUser.uid,
          battleTag: myBattleTag
        })
      }
    );

    const data = await res.json();

    if (data.result === "no matches") {
      document.getElementById("matchStatus").innerHTML =
        "<p>ìƒëŒ€ ì°¾ëŠ” ì¤‘...</p>";
    }

  } catch (e) {
    alert("ë§¤ì¹˜ ì„œë²„ ì˜¤ë¥˜");
    console.error(e);
  }
};

  // Bì¼ ê°€ëŠ¥ì„±ë„ ì²´í¬
  matchRef
    .orderByChild("players/B/uid")
    .equalTo(currentUser.uid)
    .limitToLast(1)
    .on("child_added", snap => {
      loadMatch(snap.key, snap.val());
    });
}

function loadMatch(matchId, match) {
  currentMatchId = matchId;
  currentMatch = match;
  renderMatchStatus();
}

function renderMatchStatus() {
  const div = document.getElementById("matchStatus");
  const now = Date.now();

  const meIsB = currentMatch.players.B &&
                currentMatch.players.B.uid === currentUser.uid;

  let html = `
    <p><strong>ìƒíƒœ:</strong> ${currentMatch.status}</p>
    <p><strong>ìƒëŒ€:</strong>
      ${meIsB
        ? currentMatch.players.A.battleTag
        : (currentMatch.players.B?.battleTag || "ëŒ€ê¸° ì¤‘")}
    </p>
  `;

  // ğŸ”¥ B + PENDING + 1ì‹œê°„ ì´ë‚´ â†’ ê±°ì ˆ ë²„íŠ¼
  if (
    meIsB &&
    currentMatch.status === "PENDING" &&
    now - currentMatch.createdAt < 60 * 60 * 1000
  ) {
    const remain =
      60 * 60 * 1000 - (now - currentMatch.createdAt);

    html += `
      <p style="color:#ffb347;">
        ê±°ì ˆ ê°€ëŠ¥ ë‚¨ì€ ì‹œê°„: ${Math.ceil(remain / 60000)}ë¶„
      </p>
      <button class="btn-outline"
              onclick="rejectMatch()"
              style="margin-top:10px;">
        ë§¤ì¹˜ ê±°ì ˆ
      </button>
    `;
  }

  div.innerHTML = html;
}

async function rejectMatch() {
  if (!confirm("ì´ ë§¤ì¹˜ë¥¼ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  try {
    const res = await fetch(
      "https://https://hogboxing-fucntions.vercel.app/api/match-reject",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          matchId: currentMatchId,
          uid: currentUser.uid
        })
      }
    );

    const data = await res.json();

    if (!res.ok) {
      alert(data.error || "ê±°ì ˆ ì‹¤íŒ¨");
      return;
    }

    alert("ë§¤ì¹˜ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
    location.reload();

  } catch (e) {
    alert("ì„œë²„ ì˜¤ë¥˜");
    console.error(e);
  }
}

  
  
</script>

</body>
</html>
