<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>๊ณต์ ๋งค์น๋ฉ์ดํน - ํธ๊ทธ ์ฃผ๋จน์</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="bg">

<header class="nav">
  <div class="nav-inner">
    <a href="index.html" class="logo">Hog Boxing</a>
    <nav class="menu">
      <a href="index.html">ํ</a>
      <a href="ranking.html">๋ญํน</a>
      <a href="board.html">๊ฒ์ํ</a>

      <!-- ๋ก๊ทธ์ธ ์ -->
      <a href="login.html" id="loginMenu">๋ก๊ทธ์ธ</a>

      <!-- ๋ก๊ทธ์ธ ํ -->
      <span id="userMenu" style="display:none;">
        <span id="userName" style="margin-left:15px; margin-right:5px;"></span>
        <a href="#" id="logoutBtn">๋ก๊ทธ์์</a>
      </span>
    </nav>
  </div>
</header>

<div class="page-container">

  <!-- ๋ฐฐํํ๊ทธ ๋ฑ๋ก -->
  <div id="battleTagSection" style="display:none;">
    <h1 class="page-title">๋ฐฐํํ๊ทธ ๋ฑ๋ก</h1>
    <p>
      ๊ณต์ ๋งค์น ์ฐธ์ฌ๋ฅผ ์ํด<br>
      <strong>์ค๋ฒ์์น2 ๋ฐฐํํ๊ทธ</strong>๋ฅผ ๋ฑ๋กํด์ผ ํฉ๋๋ค.
    </p>

    <input
      id="battleTagInput"
      placeholder="๋๋ค์#1234"
      style="margin-top:15px; width:250px; padding:10px;"
    />

    <br><br>
    <button id="saveBattleTag" class="btn-outline">๋ฑ๋ก</button>
  </div>

  <!-- ๋งค์น๋ฉ์ดํน -->
  <div id="matchmakingSection" style="display:none;">
    <h1 class="page-title">๊ณต์ ๋งค์น๋ฉ์ดํน</h1>

    <p id="myBattleTag"></p>

    <button id="findMatchBtn" class="btn-outline">๋งค์น ์ฐพ๊ธฐ</button>

    <div id="matchStatus" style="margin-top:25px;"></div>
  </div>

</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
let currentUser = null;
let myBattleTag = null;

/* =========================
   ๋ก๊ทธ์ธ ์ฒดํฌ
========================= */
firebase.auth().onAuthStateChanged(async user => {
  if (!user) {
    alert("๋ก๊ทธ์ธ์ด ํ์ํฉ๋๋ค.");
    location.replace("login.html");
    return;
  }

  currentUser = user;

  document.getElementById("loginMenu").style.display = "none";
  document.getElementById("userMenu").style.display = "inline";
  document.getElementById("userName").textContent =
    `[${user.displayName || user.email}]`;

  const snap = await firebase.database()
    .ref("users/" + user.uid + "/battleTag")
    .once("value");

  if (!snap.exists()) {
    document.getElementById("battleTagSection").style.display = "block";
  } else {
    myBattleTag = snap.val();
    showMatchmaking();
  }
});

/* =========================
   ๋ก๊ทธ์์
========================= */
document.getElementById("logoutBtn").onclick = e => {
  e.preventDefault();
  firebase.auth().signOut().then(() => location.reload());
};

/* =========================
   ๋ฐฐํํ๊ทธ ์์ฅ (๐ฅ ํต์ฌ ์์)
========================= */
document.getElementById("saveBattleTag").onclick = async () => {
  const input = document.getElementById("battleTagInput");
  const tag = input.value.trim();

  if (!/^.{3,12}#[0-9]{4,6}$/.test(tag)) {
    alert("๋ฐฐํํ๊ทธ ํ์์ด ์ฌ๋ฐ๋ฅด์ง ์์ต๋๋ค. (๋๋ค์#1234)");
    return;
  }

  try {
    const userRef = firebase.database().ref("users/" + currentUser.uid);

    // ๐ฅ Rules์ ๋ง๊ฒ child ๋จ์๋ก ์์ฅ
    await userRef.child("battleTag").set(tag);
    await userRef.child("createdAt").set(new Date().toISOString());

    myBattleTag = tag;
    showMatchmaking();

  } catch (e) {
    alert("๋ฐฐํํ๊ทธ ๋ฑ๋ก ์คํจ");
    console.error(e);
  }
};

/* =========================
   ๋งค์น๋ฉ์ดํน ํ๋ฉด ํ์
========================= */
function showMatchmaking() {
  document.getElementById("battleTagSection").style.display = "none";
  document.getElementById("matchmakingSection").style.display = "block";
  document.getElementById("myBattleTag").textContent =
    `๋ด ๋ฐฐํํ๊ทธ: ${myBattleTag}`;
}

/* =========================
   ๋งค์น ์ฐพ๊ธฐ (์๋ฒ ์ฐ๋ ์์)
========================= */
document.getElementById("findMatchBtn").onclick = () => {
  document.getElementById("matchStatus").innerHTML = `
    <p>๋งค์น๋ฉ์ดํน ๋๊ธฐ ์ค...</p>
    <p style="opacity:0.7;">์๋ ํ๋์ด์ด๋ฅผ ์ฐพ๊ณ ์์ต๋๋ค.</p>
  `;
};
</script>

</body>
</html>
